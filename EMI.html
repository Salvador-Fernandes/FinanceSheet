<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EMI</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://favicon.twenty.com/github.com"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      html {
        font-size: 14px;
      }
      .text-bold {
        font-weight: bold !important;
      }
      .text-color {
        color: red !important;
      }
      .text-amount {
        text-align: right !important;
      }
      .input-group .input-group-text {
        background-color: var(--bs-body-bg) !important;
        border-left: 0px !important;
      }
      .input-group .form-control {
        border-right: 0px !important;
      }
      .droparrow {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
        padding: 0.375rem 1.5rem 0.375rem 0.75rem;
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        border: var(--bs-border-width) solid var(--bs-border-color);
        border-radius: var(--bs-border-radius);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      @media print {
        .no-print,
        .no-print * {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <h1>
        <span>EMI</span>
        <div class="btn-group no-print" style="float: right !important">
          <button type="button" class="btn btn-dark" onclick="downloadData()">
            <i class="bi bi-save"></i>
          </button>
          <button type="button" class="btn btn-dark" onclick="printData()">
            <i class="bi bi-printer"></i>
          </button>
        </div>
      </h1>
    </div>
    <div class="container my-5">
      <div class="container">
        <main class="col-12">
          <form method="get">
            <div class="row g-3">
              <div class="col-12 d-inline-flex">
                <label
                  for="emitype"
                  class="form-label"
                  style="min-width: 150px !important"
                  >EMI Type</label
                >
                <select class="form-select" id="emitype" required>
                  <option value="0">Zero Cost</option>
                  <option value="1">Low Cost</option>
                </select>
              </div>
              <div class="col-12 d-inline-flex">
                <label
                  for="pramount"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Principal Amount</label
                >
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="pramount"
                    placeholder=""
                    value="0"
                    required
                  />
                  <input
                    type="button"
                    class="input-group-text droparrow"
                    id="displayAdditional"
                    value=""
                  />
                </div>
              </div>
              <div class="col-12 d-none" id="pramountdiscountvisible">
                <label
                  for="pramountdiscount"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Principal Discount</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="pramountdiscount"
                  placeholder=""
                  value="0"
                  required
                />
              </div>
              <div class="col-12 d-none" id="interestdiscountvisible">
                <label
                  for="interestdiscount"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Interest Discount</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="interestdiscount"
                  placeholder=""
                  value="0"
                  required
                />
              </div>
              <div class="col-12 d-inline-flex">
                <label
                  for="roi"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Rate of Interest</label
                >
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="roi"
                    placeholder=""
                    value="16"
                    required
                  />
                  <span class="input-group-text">%</span>
                </div>
              </div>
              <div class="col-12 d-inline-flex">
                <label
                  for="tenure"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Tenure</label
                >
                <select class="form-select" id="tenure" required>
                  <option value="3">3 Months</option>
                  <option value="6" selected>6 Months</option>
                  <option value="8">8 Months</option>
                  <option value="9">9 Months</option>
                  <option value="10">10 Months</option>
                  <option value="12">1 Year</option>
                  <option value="15">1 Year 3 Months</option>
                  <option value="18">1 Year 6 Months</option>
                  <option value="21">1 Year 9 Months</option>
                  <option value="24">2 Years</option>
                </select>
              </div>
              <div class="col-12 d-inline-flex">
                <label
                  for="procfee"
                  class="form-label"
                  style="min-width: 150px !important"
                  >Processing Fee</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="procfee"
                  placeholder=""
                  value="199"
                  required
                />
              </div>
              <div class="col-12 d-inline-flex">
                <label
                  for="gst"
                  class="form-label"
                  style="min-width: 150px !important"
                  >GST</label
                >
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="gst"
                    placeholder=""
                    value="18"
                    required
                  />
                  <span class="input-group-text">%</span>
                </div>
              </div>
              <input
                type="button"
                class="w-100 btn btn-lg btn-dark"
                type="button"
                id="process"
                value="Process"
              />
            </div>
          </form>
        </main>
        <hr />
        <main class="col-12 table-responsive">
          <table class="table">
            <tbody id="myTable"></tbody>
          </table>
        </main>
      </div>
    </div>
    <script>
      function printData() {
        window.print();
      }

      function downloadData() {
        let csv_data = [];
        let rows = document.getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
          let cols = rows[i].querySelectorAll("td,th");
          let csvrow = [];
          for (let j = 0; j < cols.length; j++) {
            csvrow.push(cols[j].innerHTML);
          }
          csv_data.push(csvrow.join(","));
        }
        csv_data = csv_data.join("\n");
        CSVFile = new Blob([csv_data], {
          type: "text/csv",
        });
        let temp_link = document.createElement("a");
        temp_link.download = "Data.csv";
        let url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;
        temp_link.style.display = "none";
        document.body.appendChild(temp_link);
        temp_link.click();
        document.body.removeChild(temp_link);
      }

      function readInput(id) {
        var value = document.getElementById(id).value;
        value = eval(value);
        return parseFloat(value);
      }

      function roundoff(value) {
        return parseFloat(value).toFixed(2);
      }

      function createCell(type, text, styles) {
        var node = document.createElement(type);
        if (styles) {
          for (let style of styles.split(" ")) {
            node.classList.add(style);
          }
        }
        var text = document.createTextNode(text);
        node.appendChild(text);
        return node;
      }

      function createRowBlank(cols) {
        var node = document.createElement("td");
        node.colSpan = cols;
        return node;
      }

      function createTable(procfee, gst, tenure, payments) {
        var myTable = document.getElementById("myTable");
        myTable.innerHTML = "";

        //Processing Fee
        var tr = document.createElement("tr");
        tr.appendChild(createCell("th", "Processing Fee"));
        tr.appendChild(createCell("td", roundoff(procfee), "text-amount"));
        tr.appendChild(createCell("th", "Tax"));
        tr.appendChild(
          createCell("td", roundoff(procfee * gst), "text-amount")
        );
        tr.appendChild(
          createCell(
            "td",
            roundoff(procfee + procfee * gst),
            "text-amount text-color"
          )
        );
        myTable.appendChild(tr);

        var tr = document.createElement("tr");
        tr.appendChild(createRowBlank(6));
        myTable.appendChild(tr);

        //Monthly Installment Calculations
        var tr = document.createElement("tr");
        tr.appendChild(createCell("th", "Principal"));
        tr.appendChild(createCell("th", "Interest"));
        tr.appendChild(createCell("th", "Tax"));
        tr.appendChild(createCell("th", "Total w/o Tax"));
        tr.appendChild(createCell("th", "Total"));
        myTable.appendChild(tr);

        for (let i = 1; i <= tenure; i++) {
          var amount = payments["amount"][i];
          var interest = payments["interest"][i];

          var tr = document.createElement("tr");
          tr.appendChild(createCell("td", roundoff(amount), "text-amount"));
          tr.appendChild(createCell("td", roundoff(interest), "text-amount"));
          tr.appendChild(
            createCell("td", roundoff(interest * gst), "text-amount")
          );
          tr.appendChild(
            createCell("td", roundoff(amount + interest), "text-amount")
          );
          tr.appendChild(
            createCell(
              "td",
              roundoff(amount + interest * (1 + gst)),
              "text-amount text-color"
            )
          );
          myTable.appendChild(tr);
        }

        var tr = document.createElement("tr");
        var totalInstall = payments["totalamount"];
        var totalInterest = payments["totalinterest"];
        tr.appendChild(
          createCell("td", roundoff(totalInstall), "text-amount text-bold")
        );
        tr.appendChild(
          createCell("td", roundoff(totalInterest), "text-amount text-bold")
        );
        tr.appendChild(
          createCell(
            "td",
            roundoff(totalInterest * gst),
            "text-amount text-bold"
          )
        );
        tr.appendChild(
          createCell(
            "td",
            roundoff(totalInstall + totalInterest),
            "text-amount text-bold"
          )
        );
        tr.appendChild(
          createCell(
            "td",
            roundoff(totalInstall + totalInterest * (1 + gst)),
            "text-amount text-bold text-color"
          )
        );
        myTable.appendChild(tr);
      }

      function calculateEMI(tenure, roi, pramount, emi) {
        var amount = [0];
        var interest = [0];
        var totalInstall = 0;
        var totalInterest = 0;
        for (let i = 1; i <= tenure; i++) {
          var tempInterest = pramount * roi;
          var tempInstall = emi - tempInterest;
          pramount -= tempInstall;
          amount.push(tempInstall);
          interest.push(tempInterest);
          totalInstall += tempInstall;
          totalInterest += tempInterest;
        }
        return {
          amount: amount,
          interest: interest,
          totalamount: totalInstall,
          totalinterest: totalInterest,
        };
      }

      document
        .getElementById("process")
        .addEventListener("click", function (event) {
          event.preventDefault();

          var procfee = readInput("procfee");
          var gst = readInput("gst") * 0.01;
          var pramount = readInput("pramount");
          var pramountdiscount = readInput("pramountdiscount");
          var interestdiscount = readInput("interestdiscount");
          var roi = readInput("roi") / 12 / 100;
          var tenure = readInput("tenure");
          var emitype = readInput("emitype");
          pramount = pramount - pramountdiscount - interestdiscount;
          var emi = (pramount * roi) / (1 - Math.pow(1 + roi, -tenure));
          var payments = calculateEMI(tenure, roi, pramount, emi);
          if (emitype == 0) {
            var nocost = 0;
            do {
              nocost = parseFloat(payments["totalinterest"]).toFixed(5);
              emi =
                ((pramount - nocost) * roi) / (1 - Math.pow(1 + roi, -tenure));
              payments = calculateEMI(tenure, roi, pramount - nocost, emi);
            } while (
              nocost != parseFloat(payments["totalinterest"]).toFixed(5)
            );
          }
          createTable(procfee, gst, tenure, payments);
        });

      document
        .getElementById("displayAdditional")
        .addEventListener("click", function (event) {
          event.preventDefault();

          var x = document.getElementById("pramountdiscountvisible");
          if (x.classList.contains("d-none")) {
            x.classList.replace("d-none", "d-inline-flex");
          } else {
            x.classList.replace("d-inline-flex", "d-none");
            document.getElementById("pramountdiscount").value = "0";
          }

          var y = document.getElementById("interestdiscountvisible");
          if (y.classList.contains("d-none")) {
            y.classList.replace("d-none", "d-inline-flex");
          } else {
            y.classList.replace("d-inline-flex", "d-none");
            document.getElementById("interestdiscount").value = "0";
          }
        });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
